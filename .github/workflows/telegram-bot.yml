name: Telegram Event Bot
on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Send Telegram notifications
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          node -e "
          const fs = require('fs');
          const https = require('https');
          
          const events = JSON.parse(fs.readFileSync('public/assets/data/events.json'));
          const now = new Date();
          
          events.forEach(event => {
            if (!event.active) return;
            const eventTime = new Date(event.date);
            const diff = Math.abs(now - eventTime);
            
            if (diff < 60000) {
              const message = \`ðŸš¨ \${event.name}\\nðŸ“… \${event.date}\\nðŸ“ \${event.location}\\n\\n\${event.description}\`;
              
              const data = JSON.stringify({
                chat_id: process.env.TELEGRAM_CHAT_ID,
                text: message
              });
              
              const req = https.request({
                hostname: 'api.telegram.org',
                path: \`/bot\${process.env.TELEGRAM_BOT_TOKEN}/sendMessage\`,
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              
              req.write(data);
              req.end();
            }
          });
          "
